name: Docker Build and Publish Image
on:
  workflow_call:
    secrets:
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true
env:
  JFROG_URL: https://newapp.jfrog.io/artifactory/
  JFROG_ARTIFACT_DIR: new-app-docker-remote-cache
  
jobs:
  
  build:
   
    runs-on: ubuntu-latest   
    steps:     
      - uses: actions/checkout@v3
     
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: Build the Docker image
        run: |
          docker build . --file Dockerfile --tag my-image-name:$(date +%s)
          pwd
          ls
          docker images
          #cat /var/lib/docker
        
      - uses: jfrog/setup-jfrog-cli@v1.2.0

        name: Setup JFrog CLI

      - name: Setup JFrog Credentials

        run: jfrog config add --artifactory-url=${{ env.JFROG_URL }} --user='${{ secrets.JFROG_USER }}' --password='${{ secrets.JFROG_PASSWORD }}'

      - name: Upload JFrog Artifacts

        #shell: bash

        #run: jfrog rt u "/var/lib/docker/my-image-name" "$JFROG_ARTIFACT_DIR/$GITHUB_RUN_ID/"
        run: |
          docker pull my-image-name
          docker tag my-image-name new-app-docker-remote/jfrog.io/my-image-name
          docker push new-app-docker-remote/jfrog.io/my-image-name
     
      
    
